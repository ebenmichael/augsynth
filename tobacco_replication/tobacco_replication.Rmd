---
title: "Replicating Abadie et al. (2010) with the `augsynth` package"
author: "Delaney & Miratrix"
date: "2024-11-16"
output: html_document
editor_options: 
  chunk_output_type: console
---


<!--
---
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{MultiSynth Vignette}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
title: "Replicating Abadie et al. (2010) with the `augsynth` package"
editor_options: 
  chunk_output_type: console
---
-->


```{r setup, include = FALSE}
library( tidyverse )
knitr::opts_chunk$set(
    collapse = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.align = 'center',
    comment = "#>"
)

## Install Synth if not already installed
# install.packages("Synth")

library(kableExtra)
library(magrittr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(tidyr)
library(rlang)

library(foreign)
library(graphics)
library(Synth)
library(augsynth)

## For the Abadie plots
replication_theme <- theme_bw(base_family = "Times New Roman") + 
    theme(panel.grid = element_blank(), 
          legend.background = element_rect(color = 'black'),
          legend.spacing.y = unit(0.0, 'pt'),
          legend.box.margin = margin(t = 5, r = 5, unit = 'pt'),
          legend.position = c(0.81, 0.9))

set.seed(1234)
```

This vignette replicates the analysis and figures in [Abadie et al. (2010)](https://web.stanford.edu/~jhain/Paper/JASA2010.pdf) using the `augsynth` package.
In particular, our recent extensions to the `augsynth` package streamline permutation-based inference and associated visualizations on behalf of the user.
In the following, we show how to easily generate results similar (but not entirely identical) to Figures 2-7 in the original paper.

While the general intuition of Abadie et al.'s analysis is replicated in the `augsynth` package, it is worth noting that covariates and model parameters are handled somewhat differently than in the original analysis. In particular, unlike the `augsynth` package, the `Synth` package used in Abadie et al.'s analysis reweights a subset of the lagged outcomes and passed auxiliary covariates when generating synthetic weights.
The `augsynth` package, by contrast, directly balances _all_ pre-treatment outcomes along with auxillary covariates, which means it does not dynamically determine variable importance weights.

In this vignette we also include `Synth` code to generate the reported Abadie et al.'s results with a high degree of fidelity (with the resulting `Synth`-based plots shown adjacent to analogous output from `augsynth` models) for comparison purposes.
We do note that we show _all_ the post-treatment years, while the original paper only shows the first 10 years post-treatment.


```{r import tobacco data, include=FALSE}
# Get working data CA and 38 control states 
Wk.data <- read.dta(here::here("./tobacco_replication/data/smoking_wkdata_39.dta"))
```

```{r Synth dataprep and model, echo=FALSE, cache=TRUE, include=FALSE}
### Run Baseline Model

# Notes
# `retprice` is the state average retail price of cigarettes (in cents)
# `K1_r_15_24` is the share of the state population aged 15-24

dataprep.out <- dataprep(
    foo = Wk.data,
    predictors = c("retprice", "xxincome", "K1_r_15_24"),
    predictors.op = c("mean"),
    dependent = c('cigsalepcap'),
    unit.variable = c('index'),
    time.variable = c('year'),
    special.predictors = list(list("xxbeer", 1984:1988, c("mean")),
                              list("cigsalepcap", 1988, c("mean")),
                              list("cigsalepcap", 1980, c("mean")),
                              list("cigsalepcap", 1975, c("mean"))
    ),
    treatment.identifier = 3,
    controls.identifier = c(1:39)[-3],
    time.predictors.prior = 1980:1988,
    time.optimize.ssr = 1970:1988,
    unit.names.variable = c('name'),
    time.plot = 1970:2005
)

### run synth

synth.out <- synth(
    dataprep.out,
    Pop.size = 300,
    Max.generations = 1,
    Unif.seed = 356987,
    Int.seed = 627478,
    Optim.method = "BFGS",
    L.ipop = 0,
    Maxiter.ipop = 1e10,
    Margin.ipop = 0.05,
    Sigf.ipop = 8,
    genoud = TRUE
)
```

```{r Abadie Figure 2, echo=FALSE, include=FALSE, fig.height=4, fig.width=4.6}
f2_plot_df <- cbind(rownames(dataprep.out$Y1plot),
                    dataprep.out$Y1plot,
                    dataprep.out$Y0plot %*% synth.out$solution.w) %>%
    as_tibble() %>%
    mutate_all(as.numeric)

colnames(f2_plot_df) <- c('year', 'California', 'Synthetic California')

f2_plot_df <- f2_plot_df %>%
    reshape2::melt(id.vars = 'year',
                   variable.name = 'treat_group',
                   value.name = 'per_cap_cigs')

path_plot <- ggplot(f2_plot_df, aes(x = year, y = per_cap_cigs, linetype = treat_group)) +
    geom_line() +
    geom_vline(linetype = 'dotted', xintercept = 1988) +
    scale_linetype_manual(values = c('solid', 'dashed'),
                          breaks = c("California", "Synthetic California")) +
    scale_y_continuous(breaks = seq(0, 141, 20), limits = c(0, 140)) +
    scale_x_continuous(breaks = seq(1970, 2005, 5), limits = c(1970, 2005)) +
    labs(linetype = NULL,
         title = 'Abadie et al. (2010), Figure 2',
         y = 'per-capita cigarette sales (in packs)') +
    annotate('text', y = 41, x = 1987.5, label = 'Passage of Proposition 99 \u2192',
             hjust = 1, color = 'black', size = 3, family = "Times New Roman") +
    annotate('text', y = 0, x = 1970, label = 'ND replication: Synth package',
             hjust = 0, color = 'darkseagreen', size = 3) +
    replication_theme

path_plot
```

```{r Abadie Figure 3, echo=FALSE, include=FALSE, fig.height=4, fig.width=4.6}
gap <- dataprep.out$Y1plot - dataprep.out$Y0plot %*% synth.out$solution.w
year <- dataprep.out$tag$time.plot

plot_df <- cbind(gap, year) %>% as_tibble()
colnames(plot_df) <- c('gap', 'year')

gap_plot <- ggplot(plot_df, aes(x = year, y = gap)) +
    geom_line() +
    geom_vline(linetype = 'dotted', xintercept = 1988) +
    geom_hline(linetype = 'dashed', yintercept = 0) +
    scale_y_continuous(breaks = seq(-30, 30, 10), limits = c(-30, 30)) +
    scale_x_continuous(breaks = seq(1970, 2005, 5), limits = c(1970, 2005)) +
    labs(linetype = NULL,
         title = 'Abadie et al. (2010), Figure 3',
         y = 'gap in per-capita cigarette sales (in packs)') +
    annotate('text', y = -25, x = 1987.5, label = 'Passage of Proposition 99 \u2192',
             hjust = 1, color = 'black', size = 3, family = "Times New Roman") +
    annotate('text', y = -30, x = 1970, label = 'ND replication: Synth package',
             hjust = 0, color = 'darkseagreen', size = 3) +
    replication_theme

gap_plot
```

### Replication with augsynth

When fitting our model, we found that using `progfunc = "none"` (meaning no ridge regression bias adjustment step, which would be seemingly more similar to Abadie) then the results deviate more strongly from the tobacco paper, but if we allow augsynth to do its default bias removal, we more closely replicate the paper.
Thus, we use ridge regresssion in this vignette, but then use the "R-statistic" permutation approahc from Abadie for inference:

```{r reformat tobacco data using tidyverse, echo=FALSE}
tobacco <- Wk.data %>%
    mutate(treated = ifelse((name == 'California') &
                                (year > 1988), 1, 0),
           state = name, # rename something meaningful
           state_index = index) %>%
    select(cigsalepcap, treated, state, year, retprice, xxincome, K1_r_15_24, xxbeer)

tobacco_70 <- tobacco %>% filter(year >= 1970) # subset data to 1970 forward to avoid issues due to missingess of outcomes

# Make beer variable and rescale proportion young people
tobacco_70 <- tobacco_70 %>% group_by( state) %>%
    mutate( beer = mean( xxbeer[ year %in% 1984:1988 ], na.rm=TRUE ),
            retail = mean( retprice[ year %in% 1980:1988 ], na.rm=TRUE ),
            K1_r_15_24 = 100 * K1_r_15_24 ) %>%
    ungroup()

```

```{r run tobacco model using augsynth}
# Basic SCM with covariates
syn <- augsynth(form = cigsalepcap ~ treated | retail + xxincome + K1_r_15_24 + beer,
                unit = state,
                time = year,
                data = tobacco_70
                #progfunc = "none"
)
syn_rstat <- summary( syn, inf_type = 'permutation_rstat' )
```

To get the outcome plot (Figure 2), call `plot(plot_type = 'outcomes')` on an `augsynth` object or summary object:

```{r  fig.width=4.5, fig.height=4}
p <- plot(syn_rstat, plot_type = 'outcomes raw average') + 
    ggtitle("Replication of Abadie et al. (2010), Figure 2")
```

```{r Format figures 2 comparison, echo=FALSE, fig.show="hold", fig.align='default', fig.height=4, fig.width=4.6}
path_plot
p 
```

Note our version has a bit of "Figure 1" in it, with the raw outcome trajectory.
If desired, setting `plot_type = 'outcomes'` will drop the raw average of donor units and the synthetic counterfactual.

To get Table 1, the comparison of the means of various covariates, we can use
```{r}
covariate_balance_table( syn, pre_period = c( 1975, 1980, 1988 ) ) %>%
    knitr::kable( digits = 2 )
```


For Figure 3, we compare the estimated impact to that calculated in the original paper:

```{r  fig.width=4.5, fig.height=3.25}
p <- plot(syn_rstat, plot_type = 'estimate only') +
    ggtitle("Replication of Abadie et al. (2010), Figure 3") +
    scale_y_continuous(limits = c(-30, 30))
```

```{r Format figures 3 comparison, echo=FALSE, fig.show="hold", fig.align='default', fig.height=4, fig.width=4.6}
gap_plot
p
```

We see a bit more choppyness than the Synth package.


We can finally plot our result, using `plot_type = "placebo"`, to obtain a plot showing each placebo trajectory:

```{r fig.width=4.5, fig.height=4}
plot(syn_rstat, plot_type = 'placebo' ) + 
    ggtitle("Replication of Abadie et al. (2010), Figure 4")
```

We can get the raw trajectories via
```{r}
placebo_distribution( syn_rstat )
```

To see what makes up our synthetic unit, we can use `donor_table()` to obtain a dataframe with the RMSPE and synthetic weight for each of the donor units.

```{r}
donor_table(syn_rstat) %>%
    arrange( -abs(weight) )
```

California is apparently mainly a mix of Colorado and Connecticut, with a bit of Utah and Nevada thrown in.
The negative weights, and the lack of sparse weights, are from the ridge regresssion.
Without that second stage, these weights would generally be sparse, as in the original paper.
For example:

```{r}
syn_classic <- augsynth(form = cigsalepcap ~ treated | retail + xxincome + K1_r_15_24 + beer,
                unit = state,
                time = year,
                data = tobacco_70,
                progfunc = "none" )
donor_table(syn_classic) %>%
    filter( weight!= 0 ) %>%
    arrange( -abs(weight) )
```


### Sensitivity checks by limiting the donor pool

The augsynth models can be re-fitted after excluding certain donor units via the `update_augsynth()` method.
The main method is to set `drop` to a multiplier for the treatment unit RMSPE.
All units with a RMSPE larger than that value will be dropped:

```{r Figures 6 and 7, echo=TRUE, eval=TRUE, fig.show="hold", fig.align='default', fig.height=4.5, fig.width=4.6}
update_augsynth(syn) %>% # drops units with >20x treated RMSPE by default
    summary( inf_type = 'permutation' ) %>%
    plot(plot_type = 'placebo' ) + 
    ggtitle("Replication of Abadie et al. (2010), Figure 5") + ylim(-51, 91) + 
    annotate('text', y = -48, x = 1970, 
             label = "Removes donors with 20x California's  pre-treatment RMSPE",
             hjust = 0, color = 'darkseagreen', size = 3) 
update_augsynth(syn, drop = 5) %>% 
    summary( inf_type = 'permutation' ) %>%
    plot(plot_type = 'placebo') + 
    ggtitle("Replication of Abadie et al. (2010), Figure 6") + ylim(-51, 91) + 
    annotate('text', y = -48, x = 1970, 
             label = "Removes donors with 5x California's pre-treatment RMSPE",
             hjust = 0, color = 'darkseagreen', size = 3) 
update_augsynth(syn, drop = 2) %>% 
    summary( inf_type = 'permutation' ) %>%
    plot(plot_type = 'placebo') + 
    ggtitle("Replication of Abadie et al. (2010), Figure 7") + ylim(-51, 91) + 
    annotate('text', y = -48, x = 1970, 
             label = "Removes donors with 2x California's pre-treatment  RMSPE",
             hjust = 0, color = 'darkseagreen', size = 3) 
```

Alternatively, the names of units to be excluded can be passed in directly as characters using `drop`. 

```{r permutation without states, echo=TRUE, eval=TRUE, fig.show="hold", fig.align='default', fig.height=4.5, fig.width=4.6}
drop_states <- c("Iowa", "Arizona", "Alabama", "Illinois", "Indiana", "Idaho", "Connecticut", 
                 "New Mexico", "Texas", "Utah", "North Dakota", "South Dakota", "Vermont", 
                 "Wisconsin", "West Virginia", "Wyoming", "Tennessee", "Pennsylvania")

update_augsynth(syn, drop = drop_states) %>% 
    summary( inf_type = 'permutation' ) %>%
    plot(plot_type = 'placebo') 
```


# The RMSPE plot

Finally, we can make Figure 8--interestingly, this does not replicate well, with CA no longer being an extreme outlier (although it still is in the tail of the distribution).
It looks like all of the outliers have pulled back substantially, vs. the original Figure 8.

```{r}

rms <- placebo_distribution( syn_rstat ) %>%
    mutate( post = ifelse( year > 1988, "post", "pre" ),
            Tx = ifelse( state == "California", "CA", "synth" ) ) %>%
    group_by( state, post, Tx ) %>%
    summarise( MSPE = mean( (Yhat - Yobs)^2 ), .groups = "drop" ) %>%
    pivot_wider( names_from = post, values_from = MSPE ) %>%
    mutate( ratio =  post / pre )

ggplot( rms, aes( ratio, fill=Tx ) ) +
    geom_dotplot( alpha = 0.5, method="histodot", binwidth = 2 ) +
    ggtitle("RMSPE ratio of post to pre-treatment periods") +
    scale_x_continuous( limits = c(0, 130 ), breaks = seq( 0,120,by=20) ) +
    replication_theme
```
